#!/bin/bash

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m' # No Color

projectName=$(basename "$(pwd)")

devContainerJsonPaths=(
    "$(pwd)/devcontainer.json"
    "$(pwd)/.devcontainer/devcontainer.json"
)

homeDirectory="${HOME}"
currentDirectory="$(pwd)"
nvimTarGzLink="https://github.com/neovim/neovim/releases/latest/download/nvim-linux64.tar.gz"
configPath="${homeDirectory}/.config/@deepdoge/devcontainer"

if [[ ! -f "${devContainerJsonPaths[0]}" && ! -f "${devContainerJsonPaths[1]}" ]]; then
    echo -e "[${RED}ERROR${NC}] No devcontainer.json found."
    exit 1
fi

devContainerJson=""
for path in "${devContainerJsonPaths[@]}"; do
    if [[ -f "${path}" ]]; then
        echo -e "[${GREEN}INFO${NC}] Found devcontainer.json at \"${path}\"."
        devContainerJson=$(sed '/^\s*\/\/.*\|\/\*.*\*\/\s*$/d' "${path}")
        break
    fi
done

if [[ -z "${devContainerJson}" ]]; then
    echo -e "[${RED}ERROR${NC}] No valid devcontainer.json found."
    exit 1
fi

# Get the directory where devcontainer.json is located
devContainerJsonDir=$(dirname "${path}")

# Extract build properties from the JSON using jq
buildDockerfile=$(echo "${devContainerJson}" | jq -r '.build.dockerfile')

if [[ -n "${buildDockerfile}" ]]; then
    echo -e "[${GREEN}INFO${NC}] Building Docker image using ${buildDockerfile}..."
    dockerFilePath="${devContainerJsonDir}/${buildDockerfile}"
    image="nvim-devcontainer--${projectName}--$(echo $dockerFilePath | sed 's/\//-/g' | sed 's/^-//g' | sed 's/-*$//g' | sed 's/\./-/g')"
    docker build -t "${image}" -f "${dockerFilePath}" "${devContainerJsonDir}"

    if [[ $? -ne 0 ]]; then
        echo -e "[${RED}ERROR${NC}] Docker build failed."
        exit 1
    fi

else
    image=$(echo "${devContainerJson}" | jq -r '.image')
    if [[ -z "${image}" ]]; then
        echo -e "[${RED}ERROR${NC}] No image specified in devcontainer.json."
        exit 1
    fi

    echo -e "[${GREEN}INFO${NC}] Pulling Docker image \"${image}\"..."
    docker pull "${image}"

    if [[ $? -ne 0 ]]; then
        echo -e "[${RED}ERROR${NC}] Docker pull failed."
        exit 1
    fi
fi

# Build, Run, and Install NeoVim to the container.
echo -e "[${GREEN}INFO${NC}] Building \"${image}\" image and running container for \"${projectName}\" project."

docker run -w "/workspaces/${projectName}" \
    -v "${currentDirectory}:/workspaces/${projectName}" \
    -v "${configPath}/nvim/config:/root/.config/nvim" \
    -v "${configPath}/nvim/cache:/root/.cache/nvim" \
    -v "${configPath}/nvim/local/state:/root/.local/state/nvim" \
    -v "${configPath}/nvim/local/share/nvim:/root/.local/share/nvim" \
    -v "${configPath}/nvim/local/share/nvim-linux64:/root/.local/share/nvim-linux64" \
    -it --rm "${image}" \
    bash -c "
            if [ ! -d ~/.local/share/nvim-linux64 ]; then
                cd /tmp &&
                curl -LO ${nvimTarGzLink} &&
                tar xzf nvim-linux64.tar.gz &&
                mkdir -p ~/.local/share &&
                mv ./nvim-linux64 ~/.local/share
            fi
            
            chmod +x ~/.local/share/nvim-linux64/bin/nvim &&
            mkdir -p ~/.local/bin
            cd ~/.local/bin/ &&
            ln -sf ~/.local/share/nvim-linux64/bin/nvim nvim
            cd \"/workspaces/${projectName}\" &&

            ~/.local/bin/nvim ; bash
        "
